<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Agro OD Batch Calculator · iPhone-friendly (Stable + Apply All)</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{ --bg:#0b1220; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --accent:#22c55e; --warn:#ef4444; }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; -webkit-font-smoothing:antialiased; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); -webkit-tap-highlight-color:transparent; }
    .app{ max-width:980px; margin:0 auto; }
    .topbar{ position:sticky; top:0; z-index:10; background:rgba(0,0,0,.2); border-bottom:1px solid var(--line); backdrop-filter:blur(8px); }
    .topbar-inner{ display:flex; align-items:center; gap:10px; padding:10px 14px; flex-wrap:wrap; }
    .title{ font-size:18px; font-weight:700; letter-spacing:.3px; }
    .controls{ margin-left:auto; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .field{ display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:8px 10px; }
    .field label{ font-size:14px; color:var(--muted); }
    .field input{ border:none; outline:none; background:transparent; color:var(--ink); font-size:16px; width:88px; height:36px; text-align:center; border-radius:10px; -webkit-appearance:none; appearance:none; }
    .btn{ height:40px; padding:0 14px; border-radius:14px; border:1px solid var(--line); background:var(--card); color:var(--ink); font-size:15px; cursor:pointer; }
    .btn:active{ transform:translateY(1px); }
    .btn.accent{ background:var(--accent); color:#06210f; border-color:transparent; font-weight:700; }
    .hint{ color:var(--muted); font-size:12px; padding:8px 14px; }
    .table-wrap{ overflow:auto; padding:12px 14px 24px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; min-width:880px; }
    th,td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:center; font-size:15px; }
    tbody tr:nth-child(odd){ background:rgba(255,255,255,.03); }
    .in{ width:90px; height:34px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--ink); text-align:center; font-size:15px; }
    .in.name{ width:140px; text-align:left; padding:0 10px; }
    .mono{ font-variant-numeric:tabular-nums; }
    .warn{ color:var(--warn); font-weight:700; }
    .footer{ color:var(--muted); font-size:12px; padding:12px 14px 20px; text-align:center; }
    .bulk-controls{ display:flex; gap:8px; padding:8px 14px; flex-wrap:wrap; }
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">Agro OD Batch Calculator</div>
      <div class="controls">
        <div class="field">
          <label for="count"># of samples</label>
          <input id="count" type="tel" inputmode="numeric" pattern="[0-9]*" value="5" aria-label="number of samples">
        </div>
        <!-- inline onclick 保證可呼叫（同時也會在 onload 自動 generate 一次） -->
        <button class="btn accent" id="btnGen" aria-label="Generate table" onclick="generate()">Generate</button>
      </div>
    </div>
  </div>

  <div class="hint">Fields: Dilution factor (default 50), Measured OD600, Target OD600, Total volume (default 1000 µL). Formula: C1V1 = C2V2.</div>

  <div class="bulk-controls">
    <div class="field"><label>Dilution</label><input id="bulkDil" type="tel" inputmode="decimal" value="50"></div>
    <div class="field"><label>Target OD</label><input id="bulkDes" type="tel" inputmode="decimal" value="0.2"></div>
    <div class="field"><label>Total Vol</label><input id="bulkVol" type="tel" inputmode="decimal" value="1000"></div>
    <button class="btn" id="btnApply" onclick="applyBulk()">Apply to all</button>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>ID / Name</th>
          <th>Dilution</th>
          <th>Measured OD600</th>
          <th>Target OD600</th>
          <th>Total Vol (µL)</th>
          <th>Stock OD</th>
          <th>Stock Vol (µL)</th>
          <th>Buffer Vol (µL)</th>
          <th>ID</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">Stable + Apply All: quickly propagate dilution, target OD, and total volume to all rows.</div>
</div>

<script>
(function(){
  // ---- helpers ----
  function $(id){ return document.getElementById(id); }
  function num(v){ v = String(v||'').replace(',', '.').trim(); var n = Number(v); return (isFinite(n) && v!=='') ? n : 0; }
  function fixed3(x){ return isFinite(x) ? Number(x).toFixed(3) : ''; }
  function cellText(txt){ var td=document.createElement('td'); td.className='mono'; td.textContent=txt; return td; }
  function cellInput(val, ph){ var td=document.createElement('td'); var inp=document.createElement('input'); inp.className='in'; inp.type='tel'; inp.inputMode='decimal'; if (ph) inp.placeholder=ph; if (typeof val!=='undefined') inp.value=String(val); td.appendChild(inp); return {td:td, input:inp}; }
  function fireInput(el){ try{ el.dispatchEvent(new Event('input',{bubbles:true})); } catch(e){ var ev=document.createEvent('Event'); ev.initEvent('input', true, true); el.dispatchEvent(ev); } }

  // ---- core compute ----
  function recompute(row){
    var dil=num(row.inDil.value), mea=num(row.inMea.value), des=num(row.inDes.value), vol=num(row.inVol.value);
    if(!dil || !mea || !des || !vol){ row.tdStock.textContent=''; row.tdV1.textContent=''; row.tdV2.textContent=''; row.tdV1.className='mono'; return; }
    var stock = mea * dil; row.tdStock.textContent = fixed3(stock);
    if(stock < des){ row.tdV1.textContent='Not feasible'; row.tdV1.className='mono warn'; row.tdV2.textContent=''; return; }
    var V1=(des*vol)/stock, V2=vol - V1; row.tdV1.textContent=Math.round(V1); row.tdV1.className='mono'; row.tdV2.textContent=Math.round(V2);
  }

  // ---- build table ----
  function generate(){
    var tbody = $('tbody'); tbody.innerHTML='';
    var raw = $('count').value; var n = num(raw); if(!n || n<1) n=1; if(n>50) n=50;

    for(var i=1;i<=n;i++){
      var tr=document.createElement('tr');

      // Left: editable ID/Name (default numeric)
      var cName=document.createElement('td');
      var inName=document.createElement('input'); inName.className='in name'; inName.type='text'; inName.value=String(i); inName.setAttribute('data-role','name');
      cName.appendChild(inName); tr.appendChild(cName);

      var cDil=cellInput(50); cDil.input.setAttribute('data-role','dil'); tr.appendChild(cDil.td);
      var cMea=cellInput('', '0.18'); cMea.input.setAttribute('data-role','mea'); tr.appendChild(cMea.td);
      var cDes=cellInput('', '0.2');  cDes.input.setAttribute('data-role','des'); tr.appendChild(cDes.td);
      var cVol=cellInput(1000); cVol.input.setAttribute('data-role','vol'); tr.appendChild(cVol.td);

      var tdStock=cellText(''); tr.appendChild(tdStock);
      var tdV1=cellText(''); tr.appendChild(tdV1);
      var tdV2=cellText(''); tr.appendChild(tdV2);

      // Right-most ID mirror
      var tdRight=document.createElement('td'); tdRight.className='mono'; tdRight.textContent=inName.value; tr.appendChild(tdRight);

      var row={ inName:inName, inDil:cDil.input, inMea:cMea.input, inDes:cDes.input, inVol:cVol.input, tdStock:tdStock, tdV1:tdV1, tdV2:tdV2, tdRightId:tdRight };

      // sync right ID when name changes
      inName.addEventListener('input', (function(r){ return function(){ r.tdRightId.textContent = r.inName.value || ''; }; })(row));

      // recompute on input
      cDil.input.addEventListener('input', (function(r){ return function(){ recompute(r); }; })(row));
      cMea.input.addEventListener('input', (function(r){ return function(){ recompute(r); }; })(row));
      cDes.input.addEventListener('input', (function(r){ return function(){ recompute(r); }; })(row));
      cVol.input.addEventListener('input', (function(r){ return function(){ recompute(r); }; })(row));

      tbody.appendChild(tr);
    }
  }

  // ---- apply bulk settings ----
  function applyBulk(){
    var dil = $('bulkDil').value;
    var des = $('bulkDes').value;
    var vol = $('bulkVol').value;
    var rows = $('tbody').querySelectorAll('tr');
    for(var i=0;i<rows.length;i++){
      var d   = rows[i].querySelector('input[data-role="dil"]');
      var desEl = rows[i].querySelector('input[data-role="des"]');
      var v   = rows[i].querySelector('input[data-role="vol"]');
      if(d){ d.value = dil; fireInput(d); }
      if(desEl){ desEl.value = des; fireInput(desEl); }
      if(v){ v.value = vol; fireInput(v); }
    }
  }

  // expose for inline onclick
  window.generate = generate;
  window.applyBulk = applyBulk;

  // render once at load (so you see initial rows even不點按鈕)
  document.addEventListener('DOMContentLoaded', function(){ try{ generate(); }catch(e){ console.error(e); } });
})();
</script>
</body>
</html>
